<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWJS Ollama IDE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default-dark/style.min.css">
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        #left-panel {
            width: 320px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            background-color: #2a2a2a;
            padding: 10px;
        }
        #file-tree {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        #context-info {
            padding: 10px;
            border-top: 1px solid #444;
        }
        #editor-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #editor {
            flex-grow: 1;
            width: 100%;
        }
        #language-select {
            padding: 10px;
            background-color: #2a2a2a;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        #lang-select, #zoom-select {
            width: auto;
            margin-right: 10px;
        }
        .jstree-default-dark .jstree-clicked {
            background-color: #4a4a4a !important;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .btn {
            margin-bottom: 10px;
        }
        #templates {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #template-select {
            flex-grow: 1;
            margin-right: 5px;
        }
        .template-btn {
            padding: 5px;
            font-size: 1.2em;
            width: 32px;
            height: 32px;
            margin-left: 5px;
        }
        #resizer {
            width: 5px;
            background-color: #444;
            cursor: col-resize;
            user-select: none;
        }
        body.resizing {
            cursor: col-resize;
            user-select: none;
        }
        body.resizing #left-panel,
        body.resizing #editor-panel {
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-dark text-light">
<div id="left-panel">
    <button id="select-project" class="btn btn-primary w-100">Выбрать директорию проекта</button>
    <div id="file-tree"></div>
    <div id="context-info" class="mt-2">
        <div>Токенов в контексте: <span id="token-count">0</span></div>
        <button id="copy-context" class="btn btn-info btn-sm mt-2 w-100">Копировать контекст</button>
    </div>
    <div id="templates" class="mt-2">
        <select id="template-select" class="form-select bg-dark text-light">
            <option value="">Выберите шаблон</option>
        </select>
        <button id="save-template" class="btn btn-success btn-sm template-btn" title="Сохранить шаблон"><i class="bi bi-save"></i></button>
        <button id="edit-template" class="btn btn-warning btn-sm template-btn" title="Редактировать шаблон"><i class="bi bi-pencil"></i></button>
        <button id="delete-template" class="btn btn-danger btn-sm template-btn" title="Удалить шаблон"><i class="bi bi-trash"></i></button>
    </div>
</div>
<div id="resizer"></div>
<div id="editor-panel">
    <div id="editor"></div>
    <div id="language-select">
        <select id="lang-select" class="form-select bg-dark text-light"></select>
        <select id="zoom-select" class="form-select bg-dark text-light">
            <option value="0.75">75%</option>
            <option value="1" selected>100%</option>
            <option value="1.25">125%</option>
            <option value="1.5">150%</option>
            <option value="2">200%</option>
        </select>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script>
    const fs = nw.require('fs');
    const path = nw.require('path');
    const gui = require('nw.gui');

    let projectPath = '';
    let editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/javascript");
    editor.setFontSize(16);

    editor.setOption("fontSize", 16);

    $('#zoom-select').on('change', function () {
        const zoom = parseFloat($(this).val());
        editor.setOption("fontSize", 16 * zoom);
    });

    $('#select-project').on('click', () => {
        const chooser = document.createElement('input');
        chooser.type = 'file';
        chooser.nwdirectory = true;

        chooser.addEventListener('change', (event) => {
            projectPath = chooser.value;
            updateFileTree();
        });

        chooser.click();
    });

    function getDirectoryStructure(dir) {
        const fs = nw.require('fs');
        const path = nw.require('path');

        function readDir(currentDir) {
            let files;
            try {
                files = fs.readdirSync(currentDir);
            } catch (error) {
                console.error(`Ошибка при чтении директории ${currentDir}:`, error);
                return [];
            }

            return files.map(file => {
                const filePath = path.join(currentDir, file);
                let stats;
                try {
                    stats = fs.statSync(filePath);
                } catch (error) {
                    console.error(`Ошибка при получении информации о файле ${filePath}:`, error);
                    return null;
                }

                if (stats.isDirectory()) {
                    return {
                        text: file,
                        children: readDir(filePath),
                        path: filePath,
                        type: 'folder',
                        icon: 'bi bi-folder'
                    };
                } else {
                    return {
                        text: file,
                        path: filePath,
                        type: 'file',
                        icon: 'bi bi-file-earmark'
                    };
                }
            }).filter(item => item !== null);
        }

        return readDir(dir);
    }

    function updateFileTree() {
        if (!projectPath) return;

        const structure = getDirectoryStructure(projectPath);
        $('#file-tree').jstree('destroy');
        $('#file-tree').jstree({
            core: {
                data: structure,
                themes: {
                    name: 'default-dark',
                    dots: false,
                    icons: true
                },
                check_callback: true
            },
            plugins: ['checkbox', 'types'],
            types: {
                file: {
                    icon: 'bi bi-file-earmark'
                },
                folder: {
                    icon: 'bi bi-folder'
                }
            },
            checkbox: {
                three_state: true,
                whole_node: false,
                tie_selection: false
            }
        });

        $('#file-tree').on('changed.jstree', (e, data) => {
            if (data.node && data.node.type === 'file') {
                openFile(data.node.original.path);
            }
            updateTokenCount();
        });

        // Добавляем обработчик события изменения состояния чекбокса
        $('#file-tree').on('check_node.jstree uncheck_node.jstree', (e, data) => {
            updateTokenCount();
        });
    }

    function openFile(filePath) {
        const fs = require('fs');
        const path = require('path');

        fs.readFile(filePath, 'utf8', (err, content) => {
            if (err) {
                console.error('Ошибка при чтении файла:', err);
                return;
            }
            editor.setValue(content);
            editor.clearSelection();

            const extension = path.extname(filePath).slice(1);
            const mode = getAceMode(extension);
            editor.session.setMode(`ace/mode/${mode}`);

            $('#lang-select').val(mode);
        });
    }

    function getAceMode(extension) {
        const modeMap = {
            'js': 'javascript',
            'py': 'python',
            'html': 'html',
            'css': 'css',
            'java': 'java',
            'cpp': 'c_cpp',
            'c': 'c_cpp',
            'rb': 'ruby',
            'php': 'php',
            'json': 'json',
            'xml': 'xml',
            'md': 'markdown',
            'sql': 'sql',
            'sh': 'sh',
            'yaml': 'yaml',
            'yml': 'yaml',
            'txt': 'text'
        };
        return modeMap[extension] || 'text';
    }

    const languages = ['javascript', 'python', 'html', 'css', 'java', 'c_cpp', 'ruby', 'php', 'json', 'xml', 'markdown', 'sql', 'sh', 'yaml', 'text'];
    languages.forEach(lang => {
        $('#lang-select').append($('<option>', {
            value: lang,
            text: lang.charAt(0).toUpperCase() + lang.slice(1)
        }));
    });

    $('#lang-select').on('change', function () {
        const selectedMode = $(this).val();
        editor.session.setMode(`ace/mode/${selectedMode}`);
    });

    function updateTokenCount() {
        const fs = require('fs');
        const selectedNodes = $('#file-tree').jstree('get_checked', true);
        let tokenCount = 0;
        let totalSize = 0;
        selectedNodes.forEach(node => {
            if (node.type === 'file') {
                const content = fs.readFileSync(node.original.path, 'utf8');
                tokenCount += content.split(/\s+/).length;
                totalSize += getFileSize(node.original.path);
            }
        });
        $('#token-count').text(`${tokenCount} (${formatFileSize(totalSize)})`);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
        else if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' MB';
        else return (bytes / 1073741824).toFixed(2) + ' GB';
    }

    function getFileSize(filePath) {
        const stats = fs.statSync(filePath);
        return stats.size;
    }

    $('#copy-context').on('click', () => {
        const selectedNodes = $('#file-tree').jstree('get_checked', true);
        let context = '';
        selectedNodes.forEach(node => {
            if (node.type === 'file') {
                const content = fs.readFileSync(node.original.path, 'utf8');
                context += `File Path: ${node.original.path}\nFile Content:\n${content}\n\n`;
            }
        });
        require('nw.gui').Clipboard.get().set(context, 'text');
        alert('Контекст скопирован в буфер обмена');
    });

    function saveTemplate() {
        const currentTemplate = $('#template-select').val();
        const name = prompt('Введите имя шаблона:', currentTemplate || '');
        if (!name) return;

        const selectedNodes = $('#file-tree').jstree('get_checked', true);
        const template = {
            name: name,
            selection: selectedNodes.map(node => node.id)
        };
        let templates = JSON.parse(localStorage.getItem('templates') || '[]');
        templates = templates.filter(t => t.name !== name);
        templates.push(template);
        localStorage.setItem('templates', JSON.stringify(templates));
        updateTemplateSelect();
        saveTemplateToFile(template);
        $('#template-select').val(name);  // Выбираем сохраненный шаблон
    }

    function loadTemplate() {
        const templateName = $('#template-select').val();
        if (!templateName) return;
        const templates = JSON.parse(localStorage.getItem('templates') || '[]');
        const template = templates.find(t => t.name === templateName);
        if (template) {
            $('#file-tree').jstree('uncheck_all');
            template.selection.forEach(nodeId => {
                $('#file-tree').jstree('check_node', nodeId);
            });
            updateTokenCount();
        }
    }

    function editTemplate() {
        const currentTemplate = $('#template-select').val();
        if (!currentTemplate) {
            alert('Пожалуйста, выберите шаблон для редактирования');
            return;
        }
        const newName = prompt('Введите новое имя шаблона:', currentTemplate);
        if (!newName || newName === currentTemplate) return;

        let templates = JSON.parse(localStorage.getItem('templates') || '[]');
        const templateIndex = templates.findIndex(t => t.name === currentTemplate);
        if (templateIndex !== -1) {
            templates[templateIndex].name = newName;
            localStorage.setItem('templates', JSON.stringify(templates));
            updateTemplateSelect();
            // Обновляем файл с шаблонами
            const fs = require('fs');
            const path = require('path');
            const filePath = path.join(projectPath, 'ai.context.json');
            if (fs.existsSync(filePath)) {
                let fileTemplates = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                if (fileTemplates[currentTemplate]) {
                    fileTemplates[newName] = fileTemplates[currentTemplate];
                    delete fileTemplates[currentTemplate];
                    fs.writeFileSync(filePath, JSON.stringify(fileTemplates, null, 2));
                }
            }
            $('#template-select').val(newName);  // Выбираем отредактированный шаблон
        }
    }

    function deleteTemplate() {
        const templateName = $('#template-select').val();
        if (!templateName) return;
        if (!confirm(`Вы уверены, что хотите удалить шаблон "${templateName}"?`)) return;

        let templates = JSON.parse(localStorage.getItem('templates') || '[]');
        templates = templates.filter(t => t.name !== templateName);
        localStorage.setItem('templates', JSON.stringify(templates));
        updateTemplateSelect();
        deleteTemplateFromFile(templateName);
    }

    function updateTemplateSelect() {
        const templates = JSON.parse(localStorage.getItem('templates') || '[]');
        const $select = $('#template-select');
        $select.empty();
        $select.append($('<option>', {value: '', text: 'Выберите шаблон'}));
        templates.forEach(template => {
            $select.append($('<option>', {value: template.name, text: template.name}));
        });
    }

    function saveTemplateToFile(template) {
        const fs = require('fs');
        const path = require('path');
        const filePath = path.join(projectPath, 'ai.context.json');
        let templates = {};
        if (fs.existsSync(filePath)) {
            templates = JSON.parse(fs.readFileSync(filePath, 'utf8'));
        }
        templates[template.name] = template.selection;
        fs.writeFileSync(filePath, JSON.stringify(templates, null, 2));
    }

    function deleteTemplateFromFile(templateName) {
        const fs = require('fs');
        const path = require('path');
        const filePath = path.join(projectPath, 'ai.context.json');
        if (fs.existsSync(filePath)) {
            let templates = JSON.parse(fs.readFileSync(filePath, 'utf8'));
            delete templates[templateName];
            fs.writeFileSync(filePath, JSON.stringify(templates, null, 2));
        }
    }

    $('#save-template').on('click', saveTemplate);
    $('#template-select').on('change', loadTemplate);
    $('#edit-template').on('click', editTemplate);
    $('#delete-template').on('click', deleteTemplate);

    // Инициализация
    updateTemplateSelect();

    function handleFileStructureChange() {
        const templates = JSON.parse(localStorage.getItem('templates') || '[]');
        templates.forEach(template => {
            template.selection = template.selection.filter(nodeId => {
                return $('#file-tree').jstree(true).get_node(nodeId);
            });
        });
        localStorage.setItem('templates', JSON.stringify(templates));
        updateTemplateSelect();
    }

    function watchProjectChanges() {
        if (!projectPath) return;

        const chokidar = require('chokidar');
        const watcher = chokidar.watch(projectPath, {
            ignored: /(^|[\/\\])\../, // ignore dotfiles
            persistent: true
        });

        watcher
            .on('add', path => {
                updateFileTree();
                handleFileStructureChange();
            })
            .on('unlink', path => {
                updateFileTree();
                handleFileStructureChange();
            })
            .on('addDir', path => {
                updateFileTree();
                handleFileStructureChange();
            })
            .on('unlinkDir', path => {
                updateFileTree();
                handleFileStructureChange();
            });
    }

    $('#select-project').on('click', () => {
        watchProjectChanges();
    });

    function updateFileContent(filePath) {
        if (editor.getValue() !== fs.readFileSync(filePath, 'utf8')) {
            openFile(filePath);
        }
    }

    let currentOpenedFile = '';
    $('#file-tree').on('changed.jstree', (e, data) => {
        if (data.node && data.node.type === 'file') {
            currentOpenedFile = data.node.original.path;
            const watcher = fs.watch(currentOpenedFile, (eventType, filename) => {
                if (eventType === 'change') {
                    updateFileContent(currentOpenedFile);
                }
            });
        }
    });

    editor.commands.addCommand({
        name: 'saveFile',
        bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
        exec: function (editor) {
            if (currentOpenedFile) {
                fs.writeFileSync(currentOpenedFile, editor.getValue(), 'utf8');
                console.log('File saved:', currentOpenedFile);
            }
        },
        readOnly: false
    });

    function updateLoadingProgress(progress) {
        console.log(`Loading progress: ${progress}%`);
        // Здесь можно добавить код для отображения прогресса загрузки в UI
    }

    function readFileAsync(filePath, callback) {
        const chunkSize = 1024 * 1024; // 1 MB chunks
        const fileSize = fs.statSync(filePath).size;
        let offset = 0;
        let progress = 0;
        let fileContent = '';

        function readChunk() {
            const buffer = Buffer.alloc(chunkSize);
            fs.read(fs.openSync(filePath, 'r'), buffer, 0, chunkSize, offset, (err, bytesRead, buffer) => {
                if (err) {
                    callback(err);
                    return;
                }

                fileContent += buffer.toString('utf8', 0, bytesRead);
                offset += bytesRead;
                progress = Math.round((offset / fileSize) * 100);
                updateLoadingProgress(progress);

                if (offset < fileSize) {
                    readChunk();
                } else {
                    callback(null, fileContent);
                }
            });
        }

        readChunk();
    }

    function openFile(filePath) {
        readFileAsync(filePath, (err, content) => {
            if (err) {
                console.error('Ошибка при чтении файла:', err);
                return;
            }
            editor.setValue(content);
            editor.clearSelection();

            const extension = path.extname(filePath).slice(1);
            const mode = getAceMode(extension);
            editor.session.setMode(`ace/mode/${mode}`);

            $('#lang-select').val(mode);
        });
    }

    // Функция для изменения размера панелей
    function initializeResizer() {
        const leftPanel = document.getElementById('left-panel');
        const resizer = document.getElementById('resizer');
        const editorPanel = document.getElementById('editor-panel');
        const body = document.body;

        let startX, startWidth;

        function startResize(e) {
            startX = e.clientX;
            startWidth = parseInt(getComputedStyle(leftPanel).width, 10);
            body.classList.add('resizing');
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault(); // Предотвращаем выделение текста
        }

        function resize(e) {
            const diff = e.clientX - startX;
            const newWidth = startWidth + diff;
            leftPanel.style.width = `${newWidth}px`;
            editorPanel.style.width = `calc(100% - ${newWidth}px)`;
        }

        function stopResize() {
            body.classList.remove('resizing');
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
            editor.resize(); // Обновляем размер редактора Ace
        }

        resizer.addEventListener('mousedown', startResize);
    }

    // Инициализация
    updateTemplateSelect();
    watchProjectChanges();
    initializeResizer();
</script>
</body>
</html>